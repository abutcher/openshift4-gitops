# openshift4-gitops
Testing OpenShift 4 Cluster Configuration With Gitops

## Installing ArgoCD on OpenShift 4

These steps will hopefully be replaced by an ArgoCD operator on OperatorHub in the near future.

```bash
oc new-project argocd
# Apply modified ArgoCD (added --insecure to disable in-container SSL) from https://raw.githubusercontent.com/argoproj/argo-cd/stable/manifests/install.yaml
oc apply -n argocd -f https://raw.githubusercontent.com/argoproj/argo-cd/stable/manifests/install.yaml
oc create route passthrough --service=argocd-server

# TODO: would rather switch this to disable the in-container SSL and let openshift handle it,
# but this does not seem to work for console logins...
#oc apply -n argocd -f argocd.yaml
#oc create route edge --service=argocd-server

# Get the argoCD 'admin' password:
ARGO_ADMIN_PASS=`kubectl get pods -n argocd -l app.kubernetes.io/name=argocd-server -o name | cut -d'/' -f 2`

# Login:
argocd login argocd-server-argocd.apps.dgoodwin-dev.new-installer.openshift.com:443 --username admin --password $ARGO_ADMIN_PASS --insecure

# Change the ArgoCD password:
argocd account update-password
argocd cluster add argocd/api-dgoodwin-dev-new-installer-openshift-com:6443/system:admin --in-cluster
```

# Configuring OpenShift 4

The following section demonstrates the use of ArgoCD to delivery some of the available [OpenShift v4 Cluster Customizations](https://docs.openshift.com/container-platform/4.1/installing/install_config/customizations.html).

## Identity Provider

The [identity-providers](./identity-providers) directory contains an example for deploying a HTPasswd OAuth provider, and the associated secret. Deploying this as an ArgoCD application should allow you to login to your cluster as user1 / MyPassword!. For information on how this secret was created, see the [OpenShift 4 Documentation](https://docs.openshift.com/container-platform/4.1/authentication/identity_providers/configuring-htpasswd-identity-provider.html#configuring-htpasswd-identity-provider).

```bash
argocd app create htpasswd-oauth --repo https://github.com/dgoodwin/openshift4-gitops.git --path=identity-providers --dest-server=https://kubernetes.default.svc --dest-namespace=openshift-config
argocd app sync htpasswd-oauth
```

This example includes a global OAuth config resource, and a namespaced secret.

WARNING: The openshift-oauth operator copies your specified secrets to the openshift-authentication, including their labels. One of these labels in added by ArgoCD to indicate the secret is owned by the htpasswd-oauth application. When this is copied, it causes ArgoCD to now see the copied secret as a resource it doesn't know about, is owned by this app, thus should be pruned. You can disable pruning on

WARNING: Deleting this htpasswd-oauth example Application from ArgoCD will fail with "DeletionError  oauths.config.openshift.io "cluster" is forbidden: deleting required oauths.config.openshift.io resource, named cluster, is not allowed". You can work around this failure with `kubectl edit applications.argoproj.io htpasswd-oauth` and removing the finalizer.

## Builds

The [builds](./builds) directory contains an example global Build configuration.

```bash
argocd app create builds-config --repo https://github.com/dgoodwin/openshift4-gitops.git --path=builds --dest-server=https://kubernetes.default.svc --dest-namespace=openshift-config
argocd app sync builds-config
```

TODO: The --dest-namespace here is odd as this example contains only a global resource.

## Console

The [console](./console) directory contains a simple configuration for the OpenShift console which simply changes the logout behavior to redirect to Google.

```bash
argocd app create console-config --repo https://github.com/dgoodwin/openshift4-gitops.git --path=console --dest-server=https://kubernetes.default.svc --dest-namespace=openshift-config
argocd app sync console-config
```

TODO: The --dest-namespace here is odd as this example contains only a global resource.

## Machine Sets

The machine-sets sub-dir contains an example MachineSet being deployed as an application via ArgoCD:

```bash
argocd app create machineset --repo https://github.com/dgoodwin/openshift4-gitops.git --path=machine-sets --dest-server=https://kubernetes.default.svc --dest-namespace=openshift-machine-api
argocd app sync machineset
```

However there is a problem here, if you [view the
yaml](./machine-sets/machinesets.yaml) you will see the cluster's generated
InfraID referenced multiple times. This value is generated by the OpenShift installer and used in the naming of many cloud objects. Committing cluster config will be problematic as this value is not known before install, and not consistent across clusters.

A standard OpenShift 4 cluster with 3 compute nodes in us-east-1 comes with 6 MachineSets, one per AZ (in my account), with only three of them scaled to 1 replicas. Each MachineSet references the generated InfraID roughly 9 times:

 - MachineSet Name
 - Selector
 - IAM Instance Profile (generated by Installer presumably)
 - Security Group Name
 - Subnet
 - AWS Tags

Ksonnet is dead. Kustomize does not think you should be doing anything based on parameters unless they're on disk. I believe Helm requires installing another component. (Tiller) Can we make Kustomize work somehow or should we explore adding another [Parameter Overrides](https://argoproj.github.io/argo-cd/user-guide/parameters/) mechanism to Argo?

ArgoCD does support adding plugins for this. However parameters may be hardcoded to only be possible for Help and Ksonnet. How could a custom config management plugin be provided variables?


# Possible ArgoCD Issues/Enhancements

 1. Create an application for a global CR without having to specify a --dest-namespace.
 1. Create an application for a namespaced CR (explicit in the yaml in git) without having to specify a --dest-namespace.
 1. CRD for a stronger Cluster API representation. (rather than Secret with a specific label)
 1. Concept of properties attached to a Cluster.
 1. Higher level "ApplicationSet" construct which automatically creates Applications for Clusters with a particular label.
 1. OpenShift Template Processing Support (or some other kind of parameter templating)

## Open Questions

 * For a CRD backed project, why is there a separate login to an application URL?
 * Does ArgoCD watch the remote cluster?
 * How many clusters has Argo been known to scale to?
 * Push vs Pull Model


