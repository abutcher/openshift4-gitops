# openshift4-gitops
Testing OpenShift 4 Cluster Configuration With Gitops

## Installing ArgoCD on OpenShift 4

These steps will hopefully be replaced by an ArgoCD operator on OperatorHub in the near future.

```bash
oc new-project argocd
# Apply modified ArgoCD (added --insecure to disable in-container SSL) from https://raw.githubusercontent.com/argoproj/argo-cd/stable/manifests/install.yaml
oc apply -n argocd -f https://raw.githubusercontent.com/argoproj/argo-cd/stable/manifests/install.yaml
oc create route passthrough --service=argocd-server

# TODO: would rather switch this to disable the in-container SSL and let openshift handle it,
# but this does not seem to work for console logins...
#oc apply -n argocd -f argocd.yaml
#oc create route edge --service=argocd-server

# Get the argoCD 'admin' password:
ARGO_ADMIN_PASS=`kubectl get pods -n argocd -l app.kubernetes.io/name=argocd-server -o name | cut -d'/' -f 2`

# Login:
argocd login argocd-server-argocd.apps.dgoodwin-dev.new-installer.openshift.com:443 --username admin --password $ARGO_ADMIN_PASS --insecure

# Change the ArgoCD password:
argocd account update-password
argocd cluster add argocd/api-dgoodwin-dev-new-installer-openshift-com:6443/system:admin --in-cluster
```

# Configuring OpenShift 4

## Machine Sets

The machine-sets sub-dir contains an example MachineSet being deployed as an application via ArgoCD:

```bash
argocd app create machineset --repo https://github.com/dgoodwin/openshift4-gitops.git --path=machine-sets --dest-server=https://kubernetes.default.svc --dest-namespace=openshift-machine-api
argocd app sync machineset
```

However there is a problem here, if you [view the
yaml](./machine-sets/machinesets.yaml) you will see the cluster's generated
InfraID referenced multiple times. This value is generated by the OpenShift installer and used in the naming of many cloud objects. Committing cluster config will be problematic as this value is not known before install, and not consistent across clusters.

A standard OpenShift 4 cluster with 3 compute nodes in us-east-1 comes with 6 MachineSets, one per AZ (in my account), with only three of them scaled to 1 replicas. Each MachineSet references the generated InfraID roughly 9 times:

 - MachineSet Name
 - Selector
 - IAM Instance Profile (generated by Installer presumably)
 - Security Group Name
 - Subnet
 - AWS Tags

Ksonnet is dead. Kustomize does not think you should be doing anything based on parameters unless they're on disk. I believe Helm requires installing another component. (Tiller) Can we make Kustomize work somehow or should we explore adding another [Parameter Overrides](https://argoproj.github.io/argo-cd/user-guide/parameters/) mechanism to Argo?

ArgoCD does support adding plugins for this. However parameters may be hardcoded to only be possible for Help and Ksonnet. How could a custom config management plugin be provided variables?

## Identity Provider

The [identity-providers] directory contains an example for deploying a HTPasswd OAuth provider, and the associated secret. Deploying this as an ArgoCD application should allow you to login to your cluster as user1 / MyPassword!. For information on how this secret was created, see the [OpenShift 4 Documentation](https://docs.openshift.com/container-platform/4.1/authentication/identity_providers/configuring-htpasswd-identity-provider.html#configuring-htpasswd-identity-provider).

```bash
argocd app create htpasswd-oauth --repo https://github.com/dgoodwin/openshift4-gitops.git --path=identity-providers --dest-server=https://kubernetes.default.svc --loglevel=debug --dest-namespace=openshift-config
argocd app sync htpasswd-oauth
```

This example includes a global OAuth config resource, and a namespaced secret.

TODO: How does this example know that the secret openshift-authentication/v4-0-config-user-idp-0-file-data should be pruned?




